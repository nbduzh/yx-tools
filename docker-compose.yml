version: '3.8'

services:
  cloudflare-speedtest:
    build:
      context: .
      dockerfile: Dockerfile
    image: cloudflare-speedtest:latest
    container_name: cloudflare-speedtest
    # 挂载数据目录，保存结果文件
    volumes:
      - ./data:/app/data
      # 可选：挂载配置文件目录
      - ./config:/app/config
      - ./logs:/var/log
    # 网络模式
    networks:
      isolated_network:
        ipv4_address: 172.60.0.10  # 指定独立IP
    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      # 定时任务配置（可选）
      - CRON_SCHEDULE=20 0 * * *  # 每天凌晨00:20
      - CRON_COMMAND=python3 /app/cloudflare_speedtest.py --mode beginner --count 10 --speed 5 --delay 200 --upload api --worker-domain subproxy.my-gift.top --uuid b6306b36-671a-4028-8664-370cccedc1a5 --clear >> /var/log/cloudflare_speedtest.log 2>&1
    # 保持容器运行（用于定时任务）
    stdin_open: true
    tty: true
    # 重启策略
    restart: unless-stopped
    # 工作目录
    working_dir: /app

networks:
  isolated_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.60.0.0/16
          gateway: 172.60.0.1

